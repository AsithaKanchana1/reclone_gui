name: "Release"

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # ── Linux (universal AppImage + deb + rpm) ──────────────
          - platform: ubuntu-22.04
            rust_target: x86_64-unknown-linux-gnu
            label: linux-x86_64
          # ── Windows ─────────────────────────────────────────────
          - platform: windows-latest
            rust_target: x86_64-pc-windows-msvc
            label: windows-x86_64

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ── System dependencies (Linux) ───────────────────────────
      - name: Install Linux deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.0-dev \
            libgtk-3-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev

      # ── Node.js ───────────────────────────────────────────────
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Node deps
        run: npm ci

      # ── Rust ──────────────────────────────────────────────────
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      # ── Enable updater for release builds ─────────────────────
      - name: Enable updater in tauri.conf.json
        shell: bash
        run: |
          cd src-tauri
          # Set updater.active = true and inject the public key
          node -e "
            const fs = require('fs');
            const conf = JSON.parse(fs.readFileSync('tauri.conf.json', 'utf8'));
            conf.tauri.updater.active = true;
            conf.tauri.updater.pubkey = process.env.TAURI_PUBLIC_KEY || '';
            fs.writeFileSync('tauri.conf.json', JSON.stringify(conf, null, 2));
          "
        env:
          TAURI_PUBLIC_KEY: ${{ secrets.TAURI_PUBLIC_KEY }}

      # ── Build ─────────────────────────────────────────────────
      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "Reclone GUI ${{ github.ref_name }}"
          releaseBody: |
            See the [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.

            ### Downloads
            | Platform | Format |
            |----------|--------|
            | Linux x86_64 | AppImage, .deb |
            | Windows x86_64 | .msi, NSIS .exe |
          releaseDraft: false
          prerelease: false
